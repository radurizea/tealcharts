<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Document</title>

        <!-- Styles -->
        <style>
            body {
                font-family: Arial, Helvetica, sans-serif;
            }
            .container {
                display: flex;
            }
            #chartdiv {
                width: 100%;
                height: 100vh;
            }
            #toggleSections {
                flex-grow: 1;
                flex-shrink: 0;
                padding: 2rem 0.5rem;
            }
            label {
                cursor: pointer;
            }
        </style>

        <!-- Resources -->
        <script src="https://cdn.amcharts.com/lib/4/core.js"></script>
        <script src="https://cdn.amcharts.com/lib/4/charts.js"></script>
        <script src="https://cdn.amcharts.com/lib/4/plugins/forceDirected.js"></script>
        <script src="https://cdn.amcharts.com/lib/4/themes/animated.js"></script>
    </head>
    <body>
        <!-- Chart code -->
        <script>
            var chart;
            var networkSeries;
            var users = [];
            var data = [];
            var answers = [];
            var selectedSections = [];

            var names = [
                'Amelia',
                'Arthur',
                'Ava',
                'Charlie',
                'Freddie',
                'George',
                'Grace',
                'Harry',
                'Isabella',
                'Isla',
                'Leo',
                'Mia',
                'Noah',
                'Oliver',
                'Olivia',
                'Oscar',
                'Sophia',
                'Theo',
            ];

            var sections = [
                { name: 'Charity', answers: [] },
                { name: 'Loyalty', answers: [] },
                { name: 'Energy', answers: [] },
                { name: 'Trust', answers: [] },
                { name: 'Action', answers: [] },
                { name: 'Inclusion', answers: [] },
                { name: 'Creativity', answers: [] },
                { name: 'Purpose', answers: [] },
                { name: 'Wisdom', answers: [] },
            ];

            names.forEach(function (name, index) {
                users.push({
                    name: name,
                    email: name.toLowerCase() + '@example.com',
                });
            });

            users.forEach(function (user, index) {
                // sections.forEach(function(section, sectionIndex) {

                var links = linkWith(index, users);

                data.push({
                    name: user.name,
                    email: user.email,
                    value: links.length,
                    linkWith: links,
                });
                // });
            });

            sections.forEach(function (section, sectionIndex) {
                users.forEach(function (user, index) {
                    var links = linkWith(index, users);
                    section.answers.push({
                        name: user.name,
                        email: user.email,
                        value: 0,
                        linkWith: links,
                    });
                });
            });

            sections.forEach(function (section, sectionIndex) {
                section.answers.forEach(function (answer) {
                    section.answers.forEach(function (a) {
                        if (a.linkWith.includes(answer.name)) {
                            answer.value++;
                        }
                    });
                });
            });


            function linkWith(index, users) {
                var numberOfConnections = Math.floor(Math.random() * 10) + 1;
                var linkWith = [];

                for (var i = 0; i < numberOfConnections; i++) {
                    var randomConnection = Math.floor(
                        Math.random() * users.length
                    );
                    linkWith.push(users[randomConnection].name);
                }

                return linkWith;
            }


            selectedSections = sections.slice();


            function drawChart(chart, networkSeries) {
                chart = am4core.create(
                    'chartdiv',
                    am4plugins_forceDirected.ForceDirectedTree
                );

                networkSeries = chart.series.push(
                    new am4plugins_forceDirected.ForceDirectedSeries()
                );

                networkSeries.dataFields.linkWith = 'linkWith';
                networkSeries.dataFields.name = 'name';
                networkSeries.dataFields.id = 'name';
                networkSeries.dataFields.value = 'value';
                // networkSeries.dataFields.children = 'children';

                networkSeries.nodes.template.label.text = '{name}';
                networkSeries.fontSize = 14;
                networkSeries.linkWithStrength = 0;

                var nodeTemplate = networkSeries.nodes.template;
                nodeTemplate.tooltipText = '{name}';
                nodeTemplate.fillOpacity = 1;
                // nodeTemplate.label.hideOversized = true;
                // nodeTemplate.label.truncate = true;

                var linkTemplate = networkSeries.links.template;
                linkTemplate.strokeWidth = 1;
                var linkHoverState = linkTemplate.states.create('hover');
                linkHoverState.properties.strokeOpacity = 1;
                linkHoverState.properties.strokeWidth = 4;

                var linkHoverState = linkTemplate.states.create('invisible');
                linkHoverState.properties.strokeOpacity = 0;
                linkHoverState.properties.strokeWidth = 1;

                var linkHoverState = linkTemplate.states.create('visible');
                linkHoverState.properties.strokeOpacity = 1;
                linkHoverState.properties.strokeWidth = 1;

                nodeTemplate.events.on('over', function (event) {
                    var dataItem = event.target.dataItem;
                    networkSeries.nodes.each(function (node) {
                        if (
                            node.dataItem.dataContext.linkWith.includes(
                                dataItem.dataContext.name
                            )
                        ) {
                            node.dataItem.childLinks.each(function (link) {
                                if (
                                    link.dataItem.dataContext.name ===
                                    dataItem.dataContext.name
                                ) {
                                    link.isHover = true;
                                } else {
                                    link.setState('invisible');
                                }
                            });
                        } else {
                            node.dataItem.childLinks.each(function (link) {
                                link.setState('invisible');
                            });
                        }
                    });
                });

                nodeTemplate.events.on('out', function (event) {
                    networkSeries.links.each(function (link) {
                        link.isHover = false;
                        link.setState('visible');
                    });
                });

                networkSeries.data = sections[0].answers;
            }

            am4core.ready(function () {
                // Themes begin
                am4core.useTheme(am4themes_animated);
                // Themes end

                drawChart(chart, networkSeries);
                
                
            }); // end am4core.ready()

            function toggleSection(e) {

                var checked = e.target.checked;
                var sectionName = e.target.name;
                var sectionIndex = selectedSections.findIndex(function(section) {
                    return section.name === sectionName;
                });

                if (!checked && sectionIndex >= 0) {
                    selectedSections.splice(sectionIndex, 1);
                } else if (checked && sectionIndex < 0) {
                    selectedSections.push(sections.find(function(section){
                        return section.name == e.target.name;
                    }))
                }        
            }

            function chartData() {
                var data = [];

                users.forEach(function(user) {
                    var userData = {
                        name: user.name,
                        email: user.email,
                        value: 0,
                        linkWith: []
                    };

                    selectedSections.forEach(function(section){
                        section.answers.forEach(function(answer){
                            if (answer.name == user.name) {
                                userData.linkWith = userData.linkWith.concat(answer.linkWith);
                                userData.linkWith = userData.linkWith.filter(onlyUnique);
                                userData.value = userData.linkWith.length;
                            }
                        });
                    });

                    data.push(userData);

                });

                return data;

            }


            function onlyUnique(value, index, self) {
                return self.indexOf(value) === index;
            }
            
        </script>

        <!-- HTML -->
        <div class="container">
            <div id="chartdiv"></div>
            <div id="toggleSections" style="display: none;">
                <p>
                    <label for="charity">
                        <input
                            type="checkbox"
                            checked
                            name="Charity"
                            id="charity"
                            onclick="toggleSection(event)"
                        />
                        Charity
                    </label>
                </p>
                <p>
                    <label for="loyalty">
                        <input
                            type="checkbox"
                            checked
                            name="Loyalty"
                            id="loyalty"
                            onclick="toggleSection(event)"
                        />
                        Loyalty
                    </label>
                </p>
                <p>
                    <label for="energy">
                        <input
                            type="checkbox"
                            checked
                            name="Energy"
                            id="energy"
                            onclick="toggleSection(event)"
                        />
                        Energy
                    </label>
                </p>
                <p>
                    <label for="trust">
                        <input
                            type="checkbox"
                            checked
                            name="Trust"
                            id="trust"
                            onclick="toggleSection(event)"
                        />
                        Trust
                    </label>
                </p>
                <p>
                    <label for="action">
                        <input
                            type="checkbox"
                            checked
                            name="Action"
                            id="action"
                            onclick="toggleSection(event)"
                        />
                        Action
                    </label>
                </p>
                <p>
                    <label for="inclusion">
                        <input
                            type="checkbox"
                            checked
                            name="Inclusion"
                            id="inclusion"
                            onclick="toggleSection(event)"
                        />
                        Inclusion
                    </label>
                </p>
                <p>
                    <label for="creativity">
                        <input
                            type="checkbox"
                            checked
                            name="Creativity"
                            id="creativity"
                            onclick="toggleSection(event)"
                        />
                        Creativity
                    </label>
                </p>
                <p>
                    <label for="purpose">
                        <input
                            type="checkbox"
                            checked
                            name="Purpose"
                            id="purpose"
                            onclick="toggleSection(event)"
                        />
                        Purpose
                    </label>
                </p>
                <p>
                    <label for="wisdom">
                        <input
                            type="checkbox"
                            checked
                            name="Wisdom"
                            id="wisdom"
                            onclick="toggleSection(event)"
                        />
                        Wisdom
                    </label>
                </p>
            </div>
        </div>
    </body>
</html>
